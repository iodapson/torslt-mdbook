<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Deref &amp; DerefMut - Tour of Rust&#x27;s Standard Library Traits (in mdbook!)</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><li class="part-title">Tour of Rust's Standard Library Traits</li><li class="chapter-item "><a href="../intro.html"><strong aria-hidden="true">1.</strong> Intro</a></li><li class="chapter-item "><a href="../chapter-1/trait-basics.html"><strong aria-hidden="true">2.</strong> Trait Basics</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../chapter-1/trait-items.html"><strong aria-hidden="true">2.1.</strong> Trait Items</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../chapter-1/self.html"><strong aria-hidden="true">2.1.1.</strong> Self</a></li><li class="chapter-item "><a href="../chapter-1/functions.html"><strong aria-hidden="true">2.1.2.</strong> Functions</a></li><li class="chapter-item "><a href="../chapter-1/methods.html"><strong aria-hidden="true">2.1.3.</strong> Methods</a></li><li class="chapter-item "><a href="../chapter-1/associated-types.html"><strong aria-hidden="true">2.1.4.</strong> Associated Types</a></li><li class="chapter-item "><a href="../chapter-1/generic-parameters.html"><strong aria-hidden="true">2.1.5.</strong> Generic Parameters</a></li><li class="chapter-item "><a href="../chapter-1/generic-types-vs-associated-types.html"><strong aria-hidden="true">2.1.6.</strong> Generic Types vs Associated Types</a></li></ol></li><li class="chapter-item "><a href="../chapter-1/scope.html"><strong aria-hidden="true">2.2.</strong> Scope</a></li><li class="chapter-item "><a href="../chapter-1/derive-macros.html"><strong aria-hidden="true">2.3.</strong> Derive Macros</a></li><li class="chapter-item "><a href="../chapter-1/default-impls.html"><strong aria-hidden="true">2.4.</strong> Default Impls</a></li><li class="chapter-item "><a href="../chapter-1/generic-blanket-impls.html"><strong aria-hidden="true">2.5.</strong> Generic Blanket Impls</a></li><li class="chapter-item "><a href="../chapter-1/subtraits--supertraits.html"><strong aria-hidden="true">2.6.</strong> Subtraits & Supertraits</a></li><li class="chapter-item "><a href="../chapter-1/trait-objects.html"><strong aria-hidden="true">2.7.</strong> Trait Objects</a></li><li class="chapter-item "><a href="../chapter-1/marker-traits.html"><strong aria-hidden="true">2.8.</strong> Marker Traits</a></li><li class="chapter-item "><a href="../chapter-1/auto-traits.html"><strong aria-hidden="true">2.9.</strong> Auto Traits</a></li><li class="chapter-item "><a href="../chapter-1/unsafe-traits.html"><strong aria-hidden="true">2.10.</strong> Unsafe Traits</a></li></ol></li><li class="chapter-item "><a href="../chapter-2/auto-traits-1.html"><strong aria-hidden="true">3.</strong> Auto Traits</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../chapter-2/send--sync.html"><strong aria-hidden="true">3.1.</strong> Send & Sync</a></li><li class="chapter-item "><a href="../chapter-2/sized.html"><strong aria-hidden="true">3.2.</strong> Sized</a></li></ol></li><li class="chapter-item "><a href="../chapter-3/general-traits.html"><strong aria-hidden="true">4.</strong> General Traits</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../chapter-3/default.html"><strong aria-hidden="true">4.1.</strong> Default</a></li><li class="chapter-item "><a href="../chapter-3/clone.html"><strong aria-hidden="true">4.2.</strong> Clone</a></li><li class="chapter-item "><a href="../chapter-3/copy.html"><strong aria-hidden="true">4.3.</strong> Copy</a></li><li class="chapter-item "><a href="../chapter-3/any.html"><strong aria-hidden="true">4.4.</strong> Any</a></li></ol></li><li class="chapter-item "><a href="../chapter-4/formatting-traits.html"><strong aria-hidden="true">5.</strong> Formatting Traits</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../chapter-4/display--tostring.html"><strong aria-hidden="true">5.1.</strong> Display & ToString</a></li><li class="chapter-item "><a href="../chapter-4/debug.html"><strong aria-hidden="true">5.2.</strong> Debug</a></li></ol></li><li class="chapter-item expanded "><a href="../chapter-5/operator-traits.html"><strong aria-hidden="true">6.</strong> Operator Traits</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../chapter-5/comparison-traits.html"><strong aria-hidden="true">6.1.</strong> Comparison Traits</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../chapter-5/partialeq--eq.html"><strong aria-hidden="true">6.1.1.</strong> PartialEq & Eq</a></li><li class="chapter-item "><a href="../chapter-5/hash.html"><strong aria-hidden="true">6.1.2.</strong> Hash</a></li><li class="chapter-item "><a href="../chapter-5/partialord--ord.html"><strong aria-hidden="true">6.1.3.</strong> PartialOrd & Ord</a></li></ol></li><li class="chapter-item "><a href="../chapter-5/arithmetic-traits.html"><strong aria-hidden="true">6.2.</strong> Arithmetic Traits</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../chapter-5/add--addassign.html"><strong aria-hidden="true">6.2.1.</strong> Add & AddAssign</a></li></ol></li><li class="chapter-item "><a href="../chapter-5/closure-traits.html"><strong aria-hidden="true">6.3.</strong> Closure Traits</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../chapter-5/fnonce-fnmut--fn.html"><strong aria-hidden="true">6.3.1.</strong> FnOnce, FnMut, & Fn</a></li></ol></li><li class="chapter-item expanded "><a href="../chapter-5/other-traits.html"><strong aria-hidden="true">6.4.</strong> Other Traits</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chapter-5/deref--derefmut.html" class="active"><strong aria-hidden="true">6.4.1.</strong> Deref & DerefMut</a></li><li class="chapter-item "><a href="../chapter-5/index--indexmut.html"><strong aria-hidden="true">6.4.2.</strong> Index & IndexMut</a></li><li class="chapter-item "><a href="../chapter-5/drop.html"><strong aria-hidden="true">6.4.3.</strong> Drop</a></li></ol></li></ol></li><li class="chapter-item "><a href="../chapter-6/conversion-traits.html"><strong aria-hidden="true">7.</strong> Conversion Traits</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../chapter-6/from--into.html"><strong aria-hidden="true">7.1.</strong> From & Into</a></li></ol></li><li class="chapter-item "><a href="../chapter-7/error-handling.html"><strong aria-hidden="true">8.</strong> Error Handling</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../chapter-7/error.html"><strong aria-hidden="true">8.1.</strong> Error</a></li></ol></li><li class="chapter-item "><a href="../chapter-8/conversion-traits-continued.html"><strong aria-hidden="true">9.</strong> Conversion Traits Continued</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../chapter-8/tryfrom--tryinto.html"><strong aria-hidden="true">9.1.</strong> TryFrom & TryInto</a></li><li class="chapter-item "><a href="../chapter-8/fromstr.html"><strong aria-hidden="true">9.2.</strong> FromStr</a></li><li class="chapter-item "><a href="../chapter-8/asref--asmut.html"><strong aria-hidden="true">9.3.</strong> AsRef & AsMut</a></li><li class="chapter-item "><a href="../chapter-8/borrow--borrowmut.html"><strong aria-hidden="true">9.4.</strong> Borrow & BorrowMut</a></li><li class="chapter-item "><a href="../chapter-8/toowned.html"><strong aria-hidden="true">9.5.</strong> ToOwned</a></li></ol></li><li class="chapter-item "><a href="../chapter-9/iteration-traits.html"><strong aria-hidden="true">10.</strong> Iteration Traits</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../chapter-9/iterator.html"><strong aria-hidden="true">10.1.</strong> Iterator</a></li><li class="chapter-item "><a href="../chapter-9/intoiterator.html"><strong aria-hidden="true">10.2.</strong> IntoIterator</a></li><li class="chapter-item "><a href="../chapter-9/fromiterator.html"><strong aria-hidden="true">10.3.</strong> FromIterator</a></li></ol></li><li class="chapter-item "><a href="../chapter-10/io-traits.html"><strong aria-hidden="true">11.</strong> I/O Traits</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../chapter-10/read--write.html"><strong aria-hidden="true">11.1.</strong> Read & Write</a></li></ol></li><li class="chapter-item "><a href="../chapter-11/conclusion.html"><strong aria-hidden="true">12.</strong> Conclusion</a></li><li class="chapter-item "><a href="../discuss.html"><strong aria-hidden="true">13.</strong> Discuss</a></li><li class="chapter-item "><a href="../notifications.html"><strong aria-hidden="true">14.</strong> Notifications</a></li><li class="chapter-item "><a href="../further-reading.html"><strong aria-hidden="true">15.</strong> Further Reading</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Tour of Rust&#x27;s Standard Library Traits (in mdbook!)</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h4 id="deref--derefmut"><a class="header" href="#deref--derefmut">Deref &amp; DerefMut</a></h4>
<p>Prerequisites</p>
<ul>
<li><a href="#self">Self</a></li>
<li><a href="#methods">Methods</a></li>
<li><a href="#associated-types">Associated Types</a></li>
<li><a href="#subtraits--supertraits">Subtraits &amp; Supertraits</a></li>
<li><a href="#sized">Sized</a></li>
</ul>
<pre><code class="language-rust">trait Deref {
    type Target: ?Sized;
    fn deref(&amp;self) -&gt; &amp;Self::Target;
}
trait DerefMut: Deref {
    fn deref_mut(&amp;mut self) -&gt; &amp;mut Self::Target;
}
</code></pre>
<p><code>Deref&lt;Target = T&gt;</code> types can be dereferenced to <code>T</code> types using the dereference operator <code>*</code>. This has obvious use-cases for smart pointer types like <code>Box</code> and <code>Rc</code>. However, we rarely see the dereference operator explicitly used in Rust code, and that's because of a Rust feature called <em>deref coercion</em>.</p>
<p>Rust automatically dereferences types when they're being passed as function arguments, returned from a function, or used as part of a method call. This is the reason why we can pass <code>&amp;String</code> and <code>&amp;Vec&lt;T&gt;</code> to functions expecting <code>&amp;str</code> and <code>&amp;[T]</code> because <code>String</code> impls <code>Deref&lt;Target = str&gt;</code> and <code>Vec&lt;T&gt;</code> impls <code>Deref&lt;Target = [T]&gt;</code>.</p>
<p><code>Deref</code> and <code>DerefMut</code> should only be implemented for smart pointer types. The most common way people attempt to misuse and abuse these traits is to try to shoehorn some kind of OOP-style data inheritance into Rust. This does not work. Rust is not OOP. Let's examine a few different situations where, how, and why it does not work. Let's start with this example:</p>
<pre><code class="language-rust">use std::ops::Deref;
struct Human {
    health_points: u32,
}
enum Weapon {
    Spear,
    Axe,
    Sword,
}
// a Soldier is just a Human with a Weapon
struct Soldier {
    human: Human,
    weapon: Weapon,
}
impl Deref for Soldier {
    type Target = Human;
    fn deref(&amp;self) -&gt; &amp;Human {
        &amp;self.human
    }
}
enum Mount {
    Horse,
    Donkey,
    Cow,
}
// a Knight is just a Soldier with a Mount
struct Knight {
    soldier: Soldier,
    mount: Mount,
}
impl Deref for Knight {
    type Target = Soldier;
    fn deref(&amp;self) -&gt; &amp;Soldier {
        &amp;self.soldier
    }
}
enum Spell {
    MagicMissile,
    FireBolt,
    ThornWhip,
}
// a Mage is just a Human who can cast Spells
struct Mage {
    human: Human,
    spells: Vec&lt;Spell&gt;,
}
impl Deref for Mage {
    type Target = Human;
    fn deref(&amp;self) -&gt; &amp;Human {
        &amp;self.human
    }
}
enum Staff {
    Wooden,
    Metallic,
    Plastic,
}
// a Wizard is just a Mage with a Staff
struct Wizard {
    mage: Mage,
    staff: Staff,
}
impl Deref for Wizard {
    type Target = Mage;
    fn deref(&amp;self) -&gt; &amp;Mage {
        &amp;self.mage
    }
}
fn borrows_human(human: &amp;Human) {}
fn borrows_soldier(soldier: &amp;Soldier) {}
fn borrows_knight(knight: &amp;Knight) {}
fn borrows_mage(mage: &amp;Mage) {}
fn borrows_wizard(wizard: &amp;Wizard) {}
fn example(human: Human, soldier: Soldier, knight: Knight, mage: Mage, wizard: Wizard) {
    // all types can be used as Humans
    borrows_human(&amp;human);
    borrows_human(&amp;soldier);
    borrows_human(&amp;knight);
    borrows_human(&amp;mage);
    borrows_human(&amp;wizard);
    // Knights can be used as Soldiers
    borrows_soldier(&amp;soldier);
    borrows_soldier(&amp;knight);
    // Wizards can be used as Mages
    borrows_mage(&amp;mage);
    borrows_mage(&amp;wizard);
    // Knights &amp; Wizards passed as themselves
    borrows_knight(&amp;knight);
    borrows_wizard(&amp;wizard);
}
</code></pre>
<p>So at first glance the above looks pretty good! However it quickly breaks down to scrutiny. First of all, deref coercion only works on references, so it doesn't work when we actually want to pass ownership:</p>
<pre><code class="language-rust">fn takes_human(human: Human) {}
fn example(human: Human, soldier: Soldier, knight: Knight, mage: Mage, wizard: Wizard) {
    // all types CANNOT be used as Humans
    takes_human(human);
    takes_human(soldier); // ‚ùå
    takes_human(knight); // ‚ùå
    takes_human(mage); // ‚ùå
    takes_human(wizard); // ‚ùå
}
</code></pre>
<p>Furthermore, deref coercion doesn't work in generic contexts. Let's say we impl some trait only on humans:</p>
<pre><code class="language-rust">trait Rest {
    fn rest(&amp;self);
}
impl Rest for Human {
    fn rest(&amp;self) {}
}
fn take_rest&lt;T: Rest&gt;(rester: &amp;T) {
    rester.rest()
}
fn example(human: Human, soldier: Soldier, knight: Knight, mage: Mage, wizard: Wizard) {
    // all types CANNOT be used as Rest types, only Human
    take_rest(&amp;human);
    take_rest(&amp;soldier); // ‚ùå
    take_rest(&amp;knight); // ‚ùå
    take_rest(&amp;mage); // ‚ùå
    take_rest(&amp;wizard); // ‚ùå
}
</code></pre>
<p>Also, although deref coercion works in a lot of places it doesn't work everywhere. It doesn't work on operands, even though operators are just syntax sugar for method calls. Let's say, to be cute, we wanted <code>Mage</code>s to learn <code>Spell</code>s using the <code>+=</code> operator:</p>
<pre><code class="language-rust">impl DerefMut for Wizard {
    fn deref_mut(&amp;mut self) -&gt; &amp;mut Mage {
        &amp;mut self.mage
    }
}
impl AddAssign&lt;Spell&gt; for Mage {
    fn add_assign(&amp;mut self, spell: Spell) {
        self.spells.push(spell);
    }
}
fn example(mut mage: Mage, mut wizard: Wizard, spell: Spell) {
    mage += spell;
    wizard += spell; // ‚ùå wizard not coerced to mage here
    wizard.add_assign(spell); // oof, we have to call it like this ü§¶
}
</code></pre>
<p>In languages with OOP-style data inheritance the value of <code>self</code> within a method is always equal to the type which called the method but in the case of Rust the value of <code>self</code> is always equal to the type which implemented the method:</p>
<pre><code class="language-rust">struct Human {
    profession: &amp;'static str,
    health_points: u32,
}
impl Human {
    // self will always be a Human here, even if we call it on a Soldier
    fn state_profession(&amp;self) {
        println!(&quot;I'm a {}!&quot;, self.profession);
    }
}
struct Soldier {
    profession: &amp;'static str,
    human: Human,
    weapon: Weapon,
}
fn example(soldier: &amp;Soldier) {
    assert_eq!(&quot;servant&quot;, soldier.human.profession);
    assert_eq!(&quot;spearman&quot;, soldier.profession);
    soldier.human.state_profession(); // prints &quot;I'm a servant!&quot;
    soldier.state_profession(); // still prints &quot;I'm a servant!&quot; ü§¶
}
</code></pre>
<p>The above gotcha is especially damning when impling <code>Deref</code> or <code>DerefMut</code> on a newtype. Let's say we want to create a <code>SortedVec</code> type which is just a <code>Vec</code> but it's always in sorted order. Here's how we might do that:</p>
<pre><code class="language-rust">struct SortedVec&lt;T: Ord&gt;(Vec&lt;T&gt;);
impl&lt;T: Ord&gt; SortedVec&lt;T&gt; {
    fn new(mut vec: Vec&lt;T&gt;) -&gt; Self {
        vec.sort();
        SortedVec(vec)
    }
    fn push(&amp;mut self, t: T) {
        self.0.push(t);
        self.0.sort();
    }
}
</code></pre>
<p>Obviously we cannot impl <code>DerefMut&lt;Target = Vec&lt;T&gt;&gt;</code> here or anyone using <code>SortedVec</code> would be able to trivially break the sorted order. However, impling <code>Deref&lt;Target = Vec&lt;T&gt;&gt;</code> surely must be safe, right? Try to spot the bug in the program below:</p>
<pre><code class="language-rust">use std::ops::Deref;
struct SortedVec&lt;T: Ord&gt;(Vec&lt;T&gt;);
impl&lt;T: Ord&gt; SortedVec&lt;T&gt; {
    fn new(mut vec: Vec&lt;T&gt;) -&gt; Self {
        vec.sort();
        SortedVec(vec)
    }
    fn push(&amp;mut self, t: T) {
        self.0.push(t);
        self.0.sort();
    }
}
impl&lt;T: Ord&gt; Deref for SortedVec&lt;T&gt; {
    type Target = Vec&lt;T&gt;;
    fn deref(&amp;self) -&gt; &amp;Vec&lt;T&gt; {
        &amp;self.0
    }
}
fn main() {
    let sorted = SortedVec::new(vec![2, 8, 6, 3]);
    sorted.push(1);
    let sortedClone = sorted.clone();
    sortedClone.push(4);
}
</code></pre>
<p>We never implemented <code>Clone</code> for <code>SortedVec</code> so when we call the <code>.clone()</code> method the compiler is using deref coercion to resolve that method call on <code>Vec</code> and so it returns a <code>Vec</code> and not a <code>SortedVec</code>!</p>
<pre><code class="language-rust">fn main() {
    let sorted: SortedVec&lt;i32&gt; = SortedVec::new(vec![2, 8, 6, 3]);
    sorted.push(1); // still sorted
    // calling clone on SortedVec actually returns a Vec ü§¶
    let sortedClone: Vec&lt;i32&gt; = sorted.clone();
    sortedClone.push(4); // sortedClone no longer sorted üíÄ
}
</code></pre>
<p>Anyway, none of the above limitations, constraints, or gotchas are faults of Rust because Rust was never designed to be an OO language or to support any OOP patterns in the first place.</p>
<p>The main takeaway from this section is do not try to be cute or clever with <code>Deref</code> and <code>DerefMut</code> impls. They're really only appropriate for smart pointer types, which can only be implemented within the standard library for now as smart pointer types currently require unstable features and compiler magic to work. If we want functionality and behavior similar to <code>Deref</code> and <code>DerefMut</code> then what we're actually probably looking for is <code>AsRef</code> and <code>AsMut</code> which we'll get to later.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../chapter-5/other-traits.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../chapter-5/index--indexmut.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../chapter-5/other-traits.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../chapter-5/index--indexmut.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
